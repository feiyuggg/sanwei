var debugFlatTerrain=!1,SGSTerrainProvider=function(e){if(!Cesium.defined(e))throw new Cesium.DeveloperError("options is required.");this._errorEvent=new Cesium.Event,this._modelFloorMasks={},this._credit=e.credit,"string"==typeof this._credit&&(this._credit=new Cesium.Credit(this._credit)),e.heightMapWidth=Cesium.defaultValue(e.heightMapWidth,32),e.heightMapHeight=Cesium.defaultValue(e.heightMapHeight,32),this._options=e,this.readyPromise=Cesium.when.resolve(!0),this._subdomains=e.subdomains,this._maxTerrainLevel=Cesium.defaultValue(e.maxTerrainLevel,30),this._useNotOptimized=e.useNotOptimized,e.firstRequestUrl=e.url.replace("{s}",this.sTag(0,0,0)),this._firstRequest=e.firstRequestUrl+"?request=GetMap&Version=1.3.0&Service=WMS&CRS=EPSG:4326&bbox=-90,-180,90,180&height=32&v=1&width=32&optimizedOnly=0&layers="+e.layerName+"&Styles=&Format=image/mpt";var r=this;function t(e,r){e._isMPT=r,e._format=r?"mpt":"png"}void 0!==e.maxTerrainLevel&&isNaN(e.maxTerrainLevel)&&(e.maxTerrainLevel=void 0),this._maxTerrainLevel=Cesium.defaultValue(e.maxTerrainLevel,25),e.pngOnly?t(r,!1):$.ajax({url:this._firstRequest,success:function(e){var i=!!(Cesium.defined(e.childNodes)&&e.childNodes.length>0);t(r,!i)},error:function(){return t(r,!1),null},async:!1}),this._urlTemplate=e.url+"?request=GetMap&Version=1.3.0&Service=WMS&v=1&CRS=EPSG:4326&bbox={south},{west},{north},{east}&height={height}&width={width}&optimizedOnly={optimizedOnly}&layers="+e.layerName+"&Styles=&Format=image/"+this._format,this._allElevationLayers=null,this._tilingScheme=new Cesium.GeographicTilingScheme,this._levelZeroMaximumGeometricError=Cesium.TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(this._tilingScheme.ellipsoid,4*e.heightMapWidth,this._tilingScheme.getNumberOfXTilesAtLevel(0)),this._workerPool=new WorkerPool({workerPath:"../SGSTerrainProvider/ParseElevationWorker.js"}),this._pendingRequests=0,this._requestGridSize=8,this._requestsCache={},this._requestsCacheKeys=[],this.errorEvent.addEventListener(function(e){},this)};const TERRAIN_PLACEHOLDER=1;function getRandomIntInclusive(e,r){return Math.floor(Math.random()*(r-e+1))+e}SGSTerrainProvider._geometricErrorFactor=2,Object.defineProperties(SGSTerrainProvider.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){return this._credit}},hasVertexNormals:{get:function(){return!1}},tilingScheme:{get:function(){return this._tilingScheme}},ready:{get:function(){return!0}},hasWaterMask:{get:function(){return!1}},heightMapHeight:{get:function(){return this._options.heightMapHeight}},heightMapWidth:{get:function(){return this._options.heightMapWidth}},pendingRequests:{get:function(){return this._pendingRequests}}}),SGSTerrainProvider.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)*SGSTerrainProvider._geometricErrorFactor},SGSTerrainProvider.prototype.createKeyFromTile=function(e,r,t){return e+"_"+r+"_"+t},SGSTerrainProvider.prototype.getTileDataAvailable=function(e,r,t){var i=Math.min(this._maxTerrainLevel,22);return this._isMPT?!this._useNotOptimized||void 0:t<i},SGSTerrainProvider.prototype.requestFactorForLevel=function(e){var r=Math.log(this._requestGridSize)/Math.log(2);return r=Math.min(r,e),Math.pow(2,r)},SGSTerrainProvider.prototype.getRequestBaseTerrainUrl=function(e,r,t,i){return this.getRequestUrl(e,r,t,i)},SGSTerrainProvider.prototype.getRequestElevationLayer=function(e,r,t){return this.getRequestUrl(e,r,t,!1,!0)},SGSTerrainProvider.prototype.getRequestUrl=function(e,r,t,i,a){var o=t,s=null!=i?this.requestFactorForLevel(t):1,n=(e=null!=i?(e-e%s)/s:e,r=null!=i?(r-r%s)/s:r,t=null!=i?t-Math.log(s)/Math.log(2):t,this.tilingScheme.tileXYToNativeRectangle(e,r,t)),u=this.heightMapWidth*s==256&&i?1:0;return a&&(u=0),this._urlTemplate.replace("{south}",n.south).replace("{north}",n.north).replace("{west}",n.west).replace("{east}",n.east).replace("{optimizedOnly}",u).replace("{width}",this.heightMapWidth*s).replace("{height}",this.heightMapHeight*s).replace("{s}",this.sTag(e,r,t))+"&level="+t+"&origLevel="+o},SGSTerrainProvider.prototype.isT_Inside_E=function(e,r){return e.west>=r.west*Cesium.Math.DEGREES_PER_RADIAN&&e.east<=r.east*Cesium.Math.DEGREES_PER_RADIAN&&e.south>=r.south*Cesium.Math.DEGREES_PER_RADIAN&&e.north<=r.north*Cesium.Math.DEGREES_PER_RADIAN},SGSTerrainProvider.prototype.isT_Intersects_E=function(e,r){var t=e.west*Cesium.Math.RADIANS_PER_DEGREE,i=e.east*Cesium.Math.RADIANS_PER_DEGREE,a=e.south*Cesium.Math.RADIANS_PER_DEGREE,o=e.north*Cesium.Math.RADIANS_PER_DEGREE,s=new Cesium.Rectangle(t,a,i,o);return Cesium.Rectangle.intersection(s,r,new Cesium.Rectangle)},SGSTerrainProvider.prototype.sTag=function(e,r,t){if(null==this._subdomains)return"";var i=(e+r+t)%this._subdomains.length;return this._subdomains[i]},SGSTerrainProvider.prototype.refreshElevationLayer=function(e){e.rectangle&&void 0!==viewer.scene.globe._surface._levelZeroTiles&&this.findDirectParent(e.rectangle,!0).freeResources()},SGSTerrainProvider.prototype.findDirectParent=function(e,r){var t=function(e,r,i){var a=i?4.1:2.1;if(e._rectangle.width<=r.width*a&&Cesium.Rectangle.contains(e._rectangle,Cesium.Rectangle.center(r)))return e;for(var o=e.children.length,s=0;s<o;s++){var n=e.children[s];if(Cesium.Rectangle.contains(n._rectangle,Cesium.Rectangle.center(r)))return t(n,r,i)}return null};if(e.width==Math.PI)return null;for(var i=0;i<viewer.scene.globe._surface._levelZeroTiles.length;i++){var a=t(viewer.scene.globe._surface._levelZeroTiles[i],e,r);if(a)return a}return null},SGSTerrainProvider.prototype.isTileAvailable=function(e,r,t){var i=this._tilingScheme.tileXYToRectangle(e,r,t,new Cesium.Rectangle),a=this.findDirectParent(i);if(a&&a.data&&a.data.terrainData){if(!(a.data.terrainData._childTileMask>0))return!1;for(var o=a.children.length,s=0;s<o;s++){var n=a.children[s];if(Cesium.Rectangle.equals(n._rectangle,i))return a.data.terrainData._childTileMask&1<<s}}return!0},SGSTerrainProvider.prototype.markTileAsUnavailable=function(e,r,t){var i=this._tilingScheme.tileXYToRectangle(e,r,t,new Cesium.Rectangle),a=this.findDirectParent(i);a&&a.data&&a.data.terrainData&&a.data.terrainData._childTileMask>0&&$.each(a.children,function(e,r){if(Cesium.Rectangle.equals(r._rectangle,i)){switch(e){case 0:a.data.terrainData._childTileMask&=-5;break;case 1:a.data.terrainData._childTileMask&=-9;break;case 2:a.data.terrainData._childTileMask&=-2;break;case 3:a.data.terrainData._childTileMask&=-3}return!1}return!0})},SGSTerrainProvider.prototype.requestBaseTerrainTileGeometry=function(e,r,t,i){return this.requestTileGeometryBuffers(e,r,t,i)},SGSTerrainProvider.prototype.requestElevationLayerTileGeometry=function(e,r,t,i,a){return this.requestTileGeometryBuffers(e,r,t,i,a)},SGSTerrainProvider.prototype.requestTileGeometryBuffers=function(e,r,t,i,a){var o,s,n,u=this,l={};l.requestedRectangle=this.tilingScheme.tileXYToNativeRectangle(e,r,t),l.layer=a;var h,d=Cesium.when.defer();if(void 0!==(h=this.requestTileHeightBuffer(e,r,t,i,void 0,a)))return o=this.requestTileHeightBuffer(e+1,r,t,i,!0,a),s=this.requestTileHeightBuffer(e,r+1,t,i,!0,a),n=this.requestTileHeightBuffer(e+1,r+1,t,i,!0,a),Cesium.when.all([h,o,s,n],function(e){if(0==debugFlatTerrain){if(null!=e[0].myReject&&e[0].myReject)return void d.reject();for(var r=u.heightMapWidth+1,t=u.heightMapHeight+1,i=new Float32Array(r*t),a=e[0].isFloor,o=0;o<r;o++)for(var s=0;s<t;s++){var n=o,h=s,c=0;s===r-1&&(h=0,c=1,a&&(c=0,h=r-2)),o===t-1&&(n=0,c=2);var f=o*r+s,m=n*u.heightMapWidth+h;null!==e[c]&&(null!=e[c].myReject&&e[c].myReject||(i[f]=e[c][m]))}null!=e[3].myReject&&e[3].myReject||(i[r*t-1]=e[3][0]);var g=u.arrayToHeightmapTerrainData(i,r,t,15);l.buffer=g,d.resolve(l)}else{g=u.arrayToHeightmapTerrainData(e[0],u.heightMapWidth,u.heightMapHeight);l.buffer=g,d.resolve(l)}}).otherwise(function(){d.reject()}),d},SGSTerrainProvider.prototype.requestTileGeometry=function(e,r,t,i){var a=this,o=[],s=a.tilingScheme.tileXYToNativeRectangle(e,r,t);null!=this._allElevationLayers&&this._allElevationLayers.length>0&&t>7?$(this._allElevationLayers).each(function(n,u){if(u.show){var l=u.rectangle;a.isT_Inside_E(s,l)?o.push(a.requestElevationLayerTileGeometry(e,r,t,i,u)):null!=a.isT_Intersects_E(s,l)?(o.push(a.requestElevationLayerTileGeometry(e,r,t,i,u)),o.push(a.requestBaseTerrainTileGeometry(e,r,t,i))):o.push(a.requestBaseTerrainTileGeometry(e,r,t,i))}else o.push(a.requestBaseTerrainTileGeometry(e,r,t,i))}):o.push(a.requestBaseTerrainTileGeometry(e,r,t,i));var n=Cesium.when.defer();return Cesium.when.all(o,function(e){if(1===e.length)void 0!==e.layer&&console.log("missing scale and offset"),n.resolve(e[0].buffer);else if(e.length>1){var r=$.grep(e,function(e){return void 0!==e.layer}),t=$.grep(e,function(e){return void 0===e.layer});if(0===r.length)n.resolve(e[0].buffer);else{var i=r[r.length-1],o=t[t.length-1],s={tolerance:i.layer.nullTolerance,nullValueNumber:i.layer.nullValueNumber,verticesX:i.layer.polygonVerticesX,verticesY:i.layer.polygonVerticesY,scale:Cesium.defaultValue(i.layer.scale,1),offset:Cesium.defaultValue(i.layer.offset,0)};n.resolve(a.mergeBuffers(o.buffer,i.buffer,s,o.requestedRectangle))}}else n.reject()}).otherwise(function(){n.reject()}),n},SGSTerrainProvider.prototype.mergeBuffers=function(e,r,t,i){var a,o,s,n,u,l=i.west,h=i.north,d=(i.east,i.south,i.width/33),c=i.height/33,f=t.scale,m=t.offset,g=t.nullValueNumber,v=t.tolerance,p=void 0!==g&&void 0!==v;if(p)var _=Cesium.defaultValue(t.nullValueNumber,0),T=Cesium.defaultValue(Number(t.tolerance),0);var y=new Float32Array(1089);for(a=0,u=h;a<33;a++,u+=c)for(o=0,n=l;o<33;o++,n+=d)y[s=33*a+o]=p?!r._buffer[s]||r._buffer[s]>=_-T&&r._buffer[s]<=_+T?e._buffer[s]:r._buffer[s]*f+m:r._buffer[s]?r._buffer[s]*f+m:e._buffer[s];return this.arrayToHeightmapTerrainData(y,33,33,15)},SGSTerrainProvider.prototype.requestTileHeightBuffer=function(e,r,t,i,a,o){if(!isNaN(e+r+t)){Cesium.defined(i)&&!1!==i||(i=new Cesium.Request({defer:!0}));var s=0==i.defer;a=Cesium.defaultValue(s,!1);var n=Cesium.when.defer();if(0==debugFlatTerrain){var u;if(void 0!==o)o.getUrlFromSTag=function(e,r,t){return void 0===o.subdomains?o.url:o.subdomains[0]+"/SG"},u=this.getRequestElevationLayer(e,r,t).replace(this._options.url,o.getUrlFromSTag(e,r,t)+"/Elevation").replace(this._options.layerName,o.name);else{u=this.getRequestBaseTerrainUrl(e,r,t,s||a);var l=viewer.terrainProvider.tilingScheme.tileXYToRectangle(e,r,t),h=Cesium.when.defer();h.resolve("NoMerge");var d=Cesium.when.defer(),c=$.grep(viewer.scene.primitives._primitives,function(e){return e instanceof Cesium.Cesium3DTileset}),f=!1;c.forEach(function(e){if(e.ready&&e.show&&void 0!==e.rootFloorRectangle&&void 0!==Cesium.Rectangle.intersection(l,e.rootFloorRectangle)){for(var r,t=new Uint16Array(1024),i=l.west,a=(l.south,(l.east-l.west)/32),o=(l.north-l.south)/32,s=0;s<32;s++)for(var n=0;n<32;n++){var u=i+a*n+a/2,h=l.north-o*s-o/2,c=new Cesium.Cartographic(u,h);r=65535;var m=e.getHRMTFP(e,c,!0);null!=m&&m.content&&m.content._model&&m.content._model.floor&&(r=m.content._model.floor.getHeight(c.longitude,c.latitude)),65535!==r?(r=r-e.origAltitude+e.realAltitude+1.5,t[32*s+n]=r):t[32*s+n]=r}f=!0,d.resolve(t)}}),f||d.resolve("NoFloor");viewer.scene.globe.ellipsoid}if(!1===this._requestsCache.hasOwnProperty(u)){if(this._requestsCache[u]={},this._requestsCacheKeys.push(u),this._requestsCacheKeys.length>100){for(var m=0;m<50;m++)delete this._requestsCache[this._requestsCacheKeys[m]];this._requestsCacheKeys.splice(0,50)}}else{var g=this._requestsCacheKeys.indexOf(u);this._requestsCacheKeys.splice(g,1),this._requestsCacheKeys.push(u)}var v=this._requestsCache[u];if(void 0===v.dataLoaded&&(s?void 0===Cesium.Resource?v.dataLoaded=Cesium.RequestScheduler.request(u,Cesium.loadArrayBuffer):v.dataLoaded=Cesium.Resource.fetchArrayBuffer(u):void 0===Cesium.Resource?v.dataLoaded=Cesium.loadArrayBuffer(u):v.dataLoaded=Cesium.Resource.fetchArrayBuffer(u),!Cesium.defined(v.dataLoaded)))return;var p=this;this._pendingRequests++,Cesium.when(v.dataLoaded,function(i){void 0===v.workerFinished&&(v.workerFinished=p._workerPool.queueWorkItem({buffer:i,isElevation:void 0!==o,level:t})),Cesium.when.all([v.workerFinished,h,d],function(i){var a=void 0!==i[1]&&"NoMerge"!==i[1],o=void 0!==i[2]&&"NoFloor"!==i[2];if(i[0].rejected){var s=p.heightMapWidth*p.heightMapHeight,u=new Int16Array(s);for(h=0;h<s;h++)u[h]=300;return t>2&&(u.myReject=!0),n.resolve(u),n}var l=p.extractTileHeightBuffer(i[0].buffer,e,r,t);if(p._pendingRequests--,a)for(var h=0;h<32;h++)for(var d=0;d<32;d++){var c=32*h+d;i[1].fromKML?l[c]=1===i[1][c]?l[c]:1==i[1].mtType?l[c]+i[1].mtHeight:2==i[1].mtType?Math.min(l[c],i[1].mtHeight):3==i[1].mtType?Math.max(l[c],i[1].mtHeight):i[1].mtHeight:l[c]=1===i[1][c]?l[c]:1==i[1].mtType?l[c]+i[1][c]:2==i[1].mtType?Math.min(l[c],i[1][c]):3==i[1].mtType?Math.max(l[c],i[1][c]):i[1][c]}if(o){for(var h=0;h<32;h++)for(d=0;d<32;d++){l[c=32*h+d]=65535===i[2][c]?l[c]:i[2][c]}l.isFloor=!0}n.resolve(l)}).otherwise(function(){for(var e=p.heightMapWidth*p.heightMapHeight,r=new Int16Array(e),i=0;i<e;i++)r[i]=300;return t>2&&(r.myReject=!0),n.resolve(r),n})}).otherwise(function(){p._pendingRequests--,n.reject()})}else{var _=this.heightMapWidth*this.heightMapHeight,T=new Int16Array(_),y=getRandomIntInclusive(0,1500);for(m=0;m<_;m++)T[m]=y;n.resolve(T)}return n}},SGSTerrainProvider.prototype.extractTileHeightBuffer=function(e,r,t,i){try{for(var a=this.requestFactorForLevel(i),o=r%a,s=t%a,n=new Int16Array(this.heightMapWidth*this.heightMapHeight),u=1e6,l=-1e5,h=0;h<this.heightMapHeight;h++)for(var d=0;d<this.heightMapWidth;d++){var c=h+s*this.heightMapHeight,f=d+o*this.heightMapWidth,m=h*this.heightMapWidth+d,g=c*this.heightMapWidth*a+f;e[g]>l&&(l=e[g]),e[g]<u&&(u=e[g]),n[m]=e[g]}}catch(e){console.log(e.message)}return n},SGSTerrainProvider.prototype.arrayToHeightmapTerrainData=function(e,r,t,i){!1===Cesium.defined(e)&&(e=new Int16Array(r*t));var a={buffer:e,width:r,height:t,childTileMask:i};return new Cesium.HeightmapTerrainData(a)};var WorkerPool=function(e){if(e=e||[],!Cesium.defined(e.workerPath))throw new Cesium.DeveloperError("workerPath is required.");this._workerPath=e.workerPath,this._poolSize=Cesium.defaultValue(e.poolSize,16),this._workers=[],this._defered=[]};function find(e,r){for(var t=0;t<e.length;t++)if(r(e[t]))return t}Object.defineProperties(WorkerPool.prototype,{errorEvent:{get:function(){return this.errorEvent}},poolSize:{get:function(){return this._poolSize}}}),WorkerPool.prototype.queueWorkItem=function(e,r){for(var t=Cesium.when.defer(),i=null,a=999999,o=0;o<this._workers.length;o++){i=this._workers[o];this._workers[o].jobQueueSize<a&&(i=this._workers[o],a=this._workers[o].jobQueueSize)}if(a>0&&this._workers.length<this.poolSize){i=new Worker(this._workerPath);var s=this;i.addEventListener("message",function(e){s.onWorkerMessage(e)},!1),i.addEventListener("error",function(e){s.onWorkerError(e)},!1),i.jobQueueSize=0,this._workers.push(i),i.id=Cesium.createGuid()}e.workerId=i.id;var n=Cesium.createGuid();return e.deferedId=n,this._defered[n]=t,i.jobQueueSize++,i.postMessage(e,r),t},WorkerPool.prototype.trimPool=function(e){var r=this;if(null==e)return null!=this.timerId&&clearTimeout(this.timerId),void(this.timerId=setTimeout(function(){r.trimPool(!0)},5e3));for(var t=0;t<this._workers.length;t++)0==this._workers[t].jobQueueSize&&(this._workers[t].terminate(),this._workers.splice(t,1),t--);this._workers.length?this.timerId=setTimeout(function(){r.trimPool(!0)},5e3):this.timerId=null},WorkerPool.prototype.onWorkerMessage=function(e){var r=e.data,t=find(this._workers,function(e){return e.id===r.workerId});null!=t&&(this._workers[t].jobQueueSize--,this.trimPool());var i=this._defered[r.deferedId];delete this._defered[r.deferedId],i.resolve(r)},WorkerPool.prototype.onWorkerError=function(e){console.log(e)};